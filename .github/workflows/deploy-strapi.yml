name: Deploy Strapi to DigitalOcean

on:
  push:
    branches: [main, production]
    paths:
      - 'acumen-strapi/**'
      - '.github/workflows/deploy-strapi.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/acumen-strapi

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./acumen-strapi
          file: ./acumen-strapi/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to DigitalOcean Droplet
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        run: |
          missing=""
          [ -z "${{ secrets.DROPLET_IP }}" ] && missing="$missing DROPLET_IP"
          [ -z "${{ secrets.DROPLET_SSH_KEY }}" ] && missing="$missing DROPLET_SSH_KEY"
          [ -z "${{ secrets.DATABASE_HOST }}" ] && missing="$missing DATABASE_HOST"
          [ -z "${{ secrets.STRAPI_DATABASE_PASSWORD }}" ] && missing="$missing STRAPI_DATABASE_PASSWORD"
          [ -z "${{ secrets.STRAPI_APP_KEYS }}" ] && missing="$missing STRAPI_APP_KEYS"
          [ -z "${{ secrets.STRAPI_API_TOKEN_SALT }}" ] && missing="$missing STRAPI_API_TOKEN_SALT"
          [ -z "${{ secrets.STRAPI_ADMIN_JWT_SECRET }}" ] && missing="$missing STRAPI_ADMIN_JWT_SECRET"
          [ -z "${{ secrets.STRAPI_TRANSFER_TOKEN_SALT }}" ] && missing="$missing STRAPI_TRANSFER_TOKEN_SALT"
          [ -z "${{ secrets.STRAPI_JWT_SECRET }}" ] && missing="$missing STRAPI_JWT_SECRET"
          
          if [ -n "$missing" ]; then
            echo "‚ùå Missing required GitHub Secrets:$missing"
            echo ""
            echo "Please add these secrets in GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo ""
            echo "Required secrets:"
            echo "  DROPLET_IP               - App server IP (167.172.66.204)"
            echo "  DROPLET_SSH_KEY          - SSH private key for root access"
            echo "  DATABASE_HOST            - MariaDB server IP (134.209.107.38)"
            echo "  STRAPI_DATABASE_PASSWORD - MariaDB password for strapi_user"
            echo "  STRAPI_APP_KEYS          - 4 comma-separated base64 keys"
            echo "  STRAPI_API_TOKEN_SALT    - Random base64 string"
            echo "  STRAPI_ADMIN_JWT_SECRET  - Random base64 string"
            echo "  STRAPI_TRANSFER_TOKEN_SALT - Random base64 string"
            echo "  STRAPI_JWT_SECRET        - Random base64 string"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Setup Server (First-Time Only)
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'bash -s' << 'SETUP_SCRIPT'
          set -e
          
          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Installing Docker..."
            apt-get update
            apt-get install -y apt-transport-https ca-certificates curl software-properties-common
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            systemctl enable docker
            systemctl start docker
            echo "‚úÖ Docker installed"
          else
            echo "‚úÖ Docker already installed"
          fi
          
          # Install netcat for DB connectivity test
          apt-get install -y netcat-openbsd 2>/dev/null || true
          
          # Create app directory
          mkdir -p /opt/acumen-strapi
          
          # Open firewall for Strapi
          if command -v ufw &> /dev/null; then
            ufw allow 1337/tcp 2>/dev/null || true
            ufw allow 22/tcp 2>/dev/null || true
          fi
          
          echo "‚úÖ Server setup complete"
          SETUP_SCRIPT

      - name: Test Database Connectivity
        run: |
          echo "üîç Testing connectivity to MariaDB server..."
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} "nc -zv ${{ secrets.DATABASE_HOST }} 3306 -w 5" || {
            echo "‚ùå Cannot reach MariaDB at ${{ secrets.DATABASE_HOST }}:3306"
            echo ""
            echo "Check that:"
            echo "  1. MariaDB is running on the DB server"
            echo "  2. bind-address is set to 0.0.0.0 in 50-server.cnf"
            echo "  3. UFW allows this app server IP on port 3306"
            echo "  4. strapi_user is created for this app server IP"
            exit 1
          }
          echo "‚úÖ Database server is reachable"

      - name: Create Environment File
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'cat > /opt/acumen-strapi/.env << EOF
          # Auto-generated by GitHub Actions - $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Hub-and-Spoke Architecture - External MariaDB
          
          # MariaDB Connection (DB Hub) - NOTE: client is 'mysql' not 'mysql2'
          DATABASE_CLIENT=mysql
          DATABASE_HOST=${{ secrets.DATABASE_HOST }}
          DATABASE_PORT=3306
          DATABASE_NAME=acumen_blog
          DATABASE_USERNAME=strapi_user
          DATABASE_PASSWORD=${{ secrets.STRAPI_DATABASE_PASSWORD }}
          DATABASE_SSL=false
          
          # Strapi Security
          APP_KEYS=${{ secrets.STRAPI_APP_KEYS }}
          API_TOKEN_SALT=${{ secrets.STRAPI_API_TOKEN_SALT }}
          ADMIN_JWT_SECRET=${{ secrets.STRAPI_ADMIN_JWT_SECRET }}
          TRANSFER_TOKEN_SALT=${{ secrets.STRAPI_TRANSFER_TOKEN_SALT }}
          JWT_SECRET=${{ secrets.STRAPI_JWT_SECRET }}
          
          # Server
          NODE_ENV=production
          HOST=0.0.0.0
          PORT=1337
          EOF'
          echo "‚úÖ Environment file created"

      - name: Deploy Application
        run: |
          # Copy docker-compose file
          scp -i ~/.ssh/deploy_key ./acumen-strapi/docker-compose.prod.yml root@${{ secrets.DROPLET_IP }}:/opt/acumen-strapi/docker-compose.yml
          
          # Pull and deploy
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'cd /opt/acumen-strapi && docker compose pull && docker compose up -d --force-recreate'
          
          # Clean up old images
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'docker image prune -af' || true
          
          echo "‚úÖ Containers started"

      - name: Wait for Strapi Health Check
        run: |
          echo "‚è≥ Waiting for Strapi to start (this may take 2-3 minutes)..."
          
          for i in {1..24}; do
            sleep 10
            echo "Health check attempt $i/24..."
            
            # Check if container is running
            status=$(ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'docker inspect --format="{{.State.Status}}" acumen-strapi 2>/dev/null' || echo "not_found")
            
            if [ "$status" = "exited" ]; then
              echo "‚ùå Container exited unexpectedly!"
              exit 1
            fi
            
            # Check health endpoint
            if ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'curl -sf http://localhost:1337/_health > /dev/null 2>&1'; then
              echo ""
              echo "üéâ =============================================="
              echo "   DEPLOYMENT SUCCESSFUL!"
              echo "   =============================================="
              echo ""
              echo "   Strapi Admin: http://${{ secrets.DROPLET_IP }}:1337/admin"
              echo "   API Endpoint: http://${{ secrets.DROPLET_IP }}:1337/api"
              echo "   Database:     ${{ secrets.DATABASE_HOST }}:3306"
              echo ""
              exit 0
            fi
          done
          
          echo "‚ùå Health check failed after 4 minutes"
          exit 1

      - name: Show Logs on Failure
        if: failure()
        run: |
          echo ""
          echo "üìã =============================================="
          echo "   STRAPI CONTAINER LOGS"
          echo "   =============================================="
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'cd /opt/acumen-strapi && docker compose logs --tail=150 strapi' || true
          
          echo ""
          echo "üìã =============================================="
          echo "   CONTAINER STATUS"
          echo "   =============================================="
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} 'cd /opt/acumen-strapi && docker compose ps' || true

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Deployment failed - check logs above for details"
            echo ""
            echo "Common issues:"
            echo "  1. Missing or incorrect GitHub Secrets"
            echo "  2. Database connection refused (check DB server firewall)"
            echo "  3. Wrong database password"
            echo "  4. MariaDB user not created for this app server IP"
          fi
